import{__rest as e}from"tslib";import t from"react";import{ChartTooltipFrame as a,ChartTooltipRow as r}from"../common/ChartTooltip.js";import{BaseColors as n}from"../../../lib/constants.js";import{colorPalette as l}from"../../../lib/theme.js";import{tremorTwMerge as o}from"../../../lib/tremorTwMerge.js";import{getColorClassNames as i,defaultValueFormatter as s}from"../../../lib/utils.js";import c from"../common/NoData.js";import u from"../../../assets/ArrowRightIcon.js";const d=10,m=["100%","75%","50%","25%","0%"],h=t.forwardRef(((h,g)=>{var p,x;const{data:v,evolutionGradient:f=!1,gradient:b=!0,valueFormatter:y=s,className:w,calculateFrom:E="first",color:X,variant:$="base",showGridLines:N=!0,showYAxis:C="previous"!==E,showXAxis:H=!0,showArrow:k=!0,yAxisPadding:B=(C?45:0),showTooltip:T=!0,onValueChange:A,customTooltip:F,noDataText:z,rotateLabelX:Y,barGap:M="20%"}=h,S=e(h,["data","evolutionGradient","gradient","valueFormatter","className","calculateFrom","color","variant","showGridLines","showYAxis","showXAxis","showArrow","yAxisPadding","showTooltip","onValueChange","customTooltip","noDataText","rotateLabelX","barGap"]),j=F,L=t.useRef(null),G=t.useRef(null),[O,R]=t.useState(0),[V,I]=t.useState(0),[D,P]=t.useState({x:0,y:0}),[W,q]=t.useState(void 0),K=!!A;const J=t.useMemo((()=>Math.max(...v.map((e=>e.value)))),[v]),Q=O-20-B,U=t.useMemo((()=>{if("number"==typeof M)return M;if("string"==typeof M&&M.endsWith("%")){const e=parseFloat(M.slice(0,-1));return Q*e/100/(v.length-1)}return console.error('Invalid barGap value. It must be a number or a percentage string (e.g., "10%").'),30}),[Q,v.length,M]),Z=t.useMemo((()=>(Q-(v.length-1)*U-U)/v.length),[Q,U,v.length]),_=V-20-(H?((null==Y?void 0:Y.xAxisHeight)||15)+10:0),ee="previous"===E,te="center"===$;t.useLayoutEffect((()=>{const e=()=>{if(L.current){const e=L.current.getBoundingClientRect();R(e.width),I(e.height)}};return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}}),[w]),t.useEffect((()=>{const e=()=>{if(G.current){const e=G.current.getBoundingClientRect();e.right>window.innerWidth&&(G.current.style.left=O-e.width+"px")}};return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}}),[D,O]);const ae=t.useMemo((()=>_<=0?[]:v.reduce(((e,t,a)=>{var r,n,l,o;const i=e[a-1],s=t.value,c=ee&&null!==(r=null==i?void 0:i.value)&&void 0!==r?r:J,u=ee&&null!==(n=null==i?void 0:i.barHeight)&&void 0!==n?n:_,d=s/c,m=d*u,h=a*(Z+U)+.5*U,g=u-m+(ee?_-(null!==(l=null==i?void 0:i.barHeight)&&void 0!==l?l:_):0),p=null===(o=v[a+1])||void 0===o?void 0:o.value,x=p/c,f=x*u,b=(a+1)*(Z+U)+.5*U;return e.push({value:s,normalizedValue:d,name:t.name,startX:h,startY:g,barHeight:m,nextValue:p,nextNormalizedValue:x,nextBarHeight:f,nextStartX:b}),e}),[])),[v,_,ee,Z,U,J]),re=e=>{var t;const a=null===(t=L.current)||void 0===t?void 0:t.getBoundingClientRect();if(!a)return;const r=a.x,s=a.y+window.scrollY,c=r+window.scrollX+B+d,u=c+(a.width-B-d),m=s+(a.height-d-(H?15:0));if(e.pageX<c||e.pageX>u||e.pageY<s||e.pageY>m)return console.log("out of bounds"),P({x:0,y:0});const h=e.pageX-r-Z/2-B-d,g=ae.reduce(((e,t)=>Math.abs(t.startX-h)<Math.abs(e.startX-h)?t:e)),p=ae.findIndex((e=>e===g));P({x:g.startX,y:g.startY,data:{dataKey:g.name,name:g.name,value:g.value,color:null!=X?X:n.Blue,className:o(i(null!=X?X:n.Blue,l.text).textColor,K?"cursor-pointer":"cursor-default"),fill:"",payload:g},index:p})};return t.createElement("div",Object.assign({ref:g,className:o("tremor-wrapper relative w-full h-80",w)},S),(null==v?void 0:v.length)?t.createElement(t.Fragment,null,t.createElement("svg",{ref:L,xmlns:"http://www.w3.org/2000/svg",className:o("w-full h-full"),onMouseMove:e=>{const t={clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY};re(t)},onTouchMove:e=>{const t=e.touches[0];re(t)},onMouseLeave:()=>P({x:0,y:0}),onTouchEnd:()=>P({x:0,y:0})},m.map(((e,a)=>t.createElement(t.Fragment,{key:`y-axis-${a}`},N?t.createElement("line",{x1:B+d,y1:a*_/4+d,x2:O-d,y2:a*_/4+d,stroke:"currentColor",className:o("stroke-1","stroke-tremor-border","dark:stroke-dark-tremor-border")}):null,t.createElement("text",{x:B-10+d,y:a*_/4+5+d,textAnchor:"end",fill:"",stroke:"",className:o("text-tremor-label","fill-tremor-content","dark:fill-dark-tremor-content")},e)))),ae.map(((e,a)=>{var r,s;return t.createElement("g",{key:`bar-${a}`},t.createElement("rect",{x:e.startX-.5*U+d+B,y:d,width:Z+U,height:_,fill:"currentColor",className:o("z-0",D.index===a?"text-[#d1d5db]/15":"text-transparent")}),b?t.createElement("rect",{x:e.startX+d+B,y:_-(ee&&(null===(r=ae[a-1])||void 0===r?void 0:r.barHeight)||_)+d,width:Z,height:(_-e.barHeight-(ee&&_-(null===(s=ae[a-1])||void 0===s?void 0:s.barHeight)||0))/(te?2:1),fill:"url(#base-gradient)",className:o(W&&W.index!==a?"opacity-30":"")}):null,t.createElement("rect",{x:e.startX+d+B,y:(te?_/2-e.barHeight/2:e.startY)+d,width:Z,height:e.barHeight,fill:"currentColor",className:o(i(null!=X?X:n.Blue,l.text).textColor,W&&W.index!==a?"opacity-30":"",K?"cursor-pointer":"cursor-default"),onClick:t=>function(e,t,a){a.stopPropagation(),K&&(t===(null==W?void 0:W.index)?(q(void 0),A(void 0)):(q({data:e,index:t}),A({eventType:"bar",categoryClicked:e.name,[e.name]:e.value,percentage:e.normalizedValue})))}(e,a,t)}),b&&te?t.createElement("rect",{x:e.startX+d+B,y:_/2+e.barHeight/2+d,width:Z,height:(_-e.barHeight)/2,fill:"url(#base-gradient-revert)",className:o(W&&W.index!==a?"opacity-30":"")}):null,H?t.createElement("foreignObject",{x:e.startX+d+B,y:_+d+10,width:Z,height:(null==Y?void 0:Y.xAxisHeight)||15,transform:Y?`rotate(${null==Y?void 0:Y.angle}, ${e.startX+Z/2+d+B}, ${_+((null==Y?void 0:Y.xAxisHeight)||15)/2+d+((null==Y?void 0:Y.verticalShift)||0)})`:void 0},t.createElement("div",{className:o("truncate text-center !text-tremor-label","text-tremor-content","dark:text-dark-tremor-content"),title:e.name},e.name)):null)})),ae.map(((e,a)=>t.createElement(t.Fragment,{key:`gradient-${a}`},a<v.length-1&&f?t.createElement(t.Fragment,null,te?t.createElement(t.Fragment,null,t.createElement("polygon",{points:`\n                                    ${e.startX+Z+d+B}, ${_/2+e.nextBarHeight/4+d}\n                                    ${e.nextStartX+d+B}, ${_/2+e.nextBarHeight/4+d}\n                                    ${e.nextStartX+d+B}, ${_/2-e.nextBarHeight/2+d}\n                                    ${e.startX+Z+d+B}, ${_/2-e.barHeight/2+d}\n                                  `,fill:"url(#base-gradient)",className:o("z-10",W&&W.index!==a?"opacity-30":"")}),t.createElement("polygon",{points:`\n                                    ${e.startX+Z+d+B}, ${_/2+e.barHeight/2+d}\n                                    ${e.nextStartX+d+B}, ${_/2+e.nextBarHeight/2+d}\n                                    ${e.nextStartX+d+B}, ${_/2-e.nextBarHeight/4+d}\n                                    ${e.startX+Z+d+B}, ${_/2-e.nextBarHeight/4+d}\n                                  `,fill:"url(#base-gradient-revert)",className:o("z-10",W&&W.index!==a?"opacity-30":"")})):t.createElement("polygon",{points:`\n                                  ${e.startX+Z+d+B}, ${e.startY+d} \n                                  ${e.nextStartX+d+B}, ${_-e.nextBarHeight+d} \n                                  ${e.nextStartX+d+B}, ${_+d} \n                                  ${e.startX+Z+d+B}, ${_+d}\n                                `,fill:"url(#base-gradient)",className:o("z-10",W&&W.index!==a?"opacity-30":"")})):null,a<v.length-1&&H&&k&&U>=14?t.createElement("foreignObject",{x:e.startX+Z+d+B-6+U/2,y:_+d+11,width:12,height:(null==Y?void 0:Y.xAxisHeight)||15},t.createElement("div",{className:o("text-tremor-content","dark:text-dark-tremor-content")},t.createElement(u,{className:"size-3.5 shrink-0"}))):null))),t.createElement("linearGradient",{id:"base-gradient",x1:"0%",y1:"0%",x2:"0%",y2:"100%",className:o(i(null!=X?X:n.Blue,l.text).textColor)},t.createElement("stop",{offset:"5%",stopColor:"currentColor",stopOpacity:.4}),t.createElement("stop",{offset:"95%",stopColor:"currentColor",stopOpacity:0})),t.createElement("linearGradient",{id:"base-gradient-revert",x1:"0%",y1:"0%",x2:"0%",y2:"100%",className:o(i(null!=X?X:n.Blue,l.text).textColor)},t.createElement("stop",{offset:"5%",stopColor:"currentColor",stopOpacity:0}),t.createElement("stop",{offset:"95%",stopColor:"currentColor",stopOpacity:.4}))),T?t.createElement("div",{ref:G,className:o("absolute top-0 pointer-events-none",D.data?"visible":"hidden"),tabIndex:-1,role:"dialog",style:{left:D.x+.66*Z}},j?t.createElement(j,{payload:D.data?[D.data]:[],active:!!D.data,label:null===(p=D.data)||void 0===p?void 0:p.name}):t.createElement(a,null,t.createElement("div",{className:o("border-tremor-border border-b px-4 py-2","dark:border-dark-tremor-border")},t.createElement("p",{className:o("font-medium","text-tremor-content-emphasis","dark:text-dark-tremor-content-emphasis")},null===(x=null==D?void 0:D.data)||void 0===x?void 0:x.name)),t.createElement("div",{className:o("px-4 py-2 space-y-1")},D.data?t.createElement(r,{value:y(D.data.value),name:`${(100*D.data.payload.normalizedValue).toFixed(2)}%`,color:null!=X?X:n.Blue}):null))):null):t.createElement(c,{noDataText:z}))}));h.displayName="FunnelChart";const g=a=>{var{data:r}=a,n=e(a,["data"]);const l=r?((e,t)=>{if(e&&e.length>0){if("previous"===t&&e[0].value<=0)return`The value of the first item "${e[0].name}" is not greater than 0. This is not allowed when setting the "calculateFrom" prop to "previous". Please enter a value greater than 0.`;for(const t of e)if(t.value<0)return`Item "${t.name}" has a negative value: ${t.value}. This is not allowed. The value must be greater than or equal to 0.`}return null})(r,n.calculateFrom):null;return l?t.createElement(c,{className:"h-full w-full p-6",noDataText:`Calculation error: ${l}`}):t.createElement(h,Object.assign({data:r},n))};export{g as default};
